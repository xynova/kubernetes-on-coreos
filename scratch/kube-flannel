

export ETCD_ENDPOINTS=${ETCD_ENDPOINTS:=http://172.17.4.51:2379}
export LOCAL_REGISTRY_ENDPOINT=${LOCAL_REGISTRY:=http://172.17.4.10:5000}
export MACHINE_IP=$(awk -F= '/COREOS_PRIVATE_IPV4/ {print $2}' /etc/environment)


#STOP LOCKSMIDTHD

sudo systemctl disable locksmithd.service
sudo systemctl stop locksmithd.service


#FLANNEL
#--------------------------------------

#CREATE FLANNELD NETWORK
DIR=/etc/systemd/system/flanneld.service.d
sudo mkdir -p $DIR && cat << EOF | sudo tee "${DIR}/10-network-config.conf"
[Service]
ExecStartPre=/usr/bin/etcdctl --endpoints=$ETCD_ENDPOINTS set /coreos.com/network/config '{ "Network": "10.1.0.0/16" , "Backend":{"Type":"vxlan"} }'
EOF


# CREATE FLANNELD ENVS
sudo mkdir -p /etc/flannel
sudo touch /etc/flannel/options.env
cat << EOF | sudo tee  /etc/flannel/options.env
FLANNELD_IFACE=$MACHINE_IP
FLANNELD_ETCD_ENDPOINTS=$ETCD_ENDPOINTS
EOF

sudo mkdir -p /etc/systemd/system/flanneld.service.d
cat << EOF | sudo tee /etc/systemd/system/flanneld.service.d/40-ExecStartPre-symlink.conf
[Service]
ExecStartPre=/usr/bin/ln -sf /etc/flannel/options.env /run/flannel/options.env
EOF


#START FLANNELD SERVICE

sudo systemctl daemon-reload
sudo systemctl enable flanneld
sudo systemctl start flanneld


#DELETE DOCKER0 BRIDGE

sudo systemctl stop docker
sudo ifconfig docker0 down 2> /dev/null
sudo brctl delbr docker0 2> /dev/null
sudo systemctl enable docker
sudo systemctl start docker






